\chapter{Signal extraction fit}
\label{ref:fit}

To extract \RD and \RDst, the parameters of interest,
a simultaneous \emph{signal fit}
to both \Dz and \Dstar channels with the ISO skim\footnote{
    As a reminder, ``skim'' means \emph{subsample}.
    The selection criteria for all four skims (ISO, 1OS, 2OS, DD) is defined at
    \cref{ref:sel:skims}.
} is performed.
As briefly discussed in \cref{ref:overview},
the parameters responsible for controlling the shapes of the \Dstst and
$DDX$ backgrounds,
such as the \Dstst form factors and $DDX$ Dalitz-inspired shape variations,
are \emph{insensitive} to the signal fit as they constitute only a small
fraction of the ISO data skim.
Therefore these parameters are obtained with a \emph{control fit},
a simultaneous fit to the 1OS, 2OS, and DD control skims with six fit channels
(a \Dz and a \Dstar channel for each control skim),
and imported back to the signal fit at the fitted values with either
fitted errors as constraints (for \Dstst shape parameters) or fully fixed
(for $DDX$ shape parameters).
To be more precise,
the fit procedure is broken into 3 steps:

\begin{enumerate}
    \item \textbf{Pre-control}:
        Performed on control samples (1OS, 2OS, DD).
        In this step, all but the \Kstar variations are turned off.
    \item \textbf{Control}:
        Performed on control samples (1OS, 2OS, DD).
        All but the signal and normalization variations are turned on.
        The fitted parameters from previous steps are loaded along with their
        errors as a starting point for the control fit.
    \item \textbf{Signal}:
        Performed on signal sample (ISO).
        The variations for $D^{**}, D_H^{**}$, and misID DiF are loaded as
        constraints to the signal fit;
        the $DDX$ variations are set to constant with fitted value from previous
        step,
\end{enumerate}
The terms such as ``\Kstar variations'' and ``misID DiF'' will be defined later.

Both the signal and the control fit are binned extended maximum likelihood
template fits,
with a fitter based on the \HistFactory fitter
used in the pathfinder run 1 \RDX analysis described in
\cite{LHCb-ANA-2020-056}\footnote{
    With code refactored and dependencies updated to enhance readability and
    configurability,
    but the fit model is largely the same.
}.
% Fit variables, include binning
The fit templates are three-dimensional correlation-preserving
histograms of \mmSq, \el, and \qSq,
with binning scheme listed in \cref{tab:fit-vars-binning}.
Events outside the binning ranges of the fit variables are cut out to avoid
potential impact of under/overflow bins on the fitter.
To account for external constraints on fit parameters or uncertainties on
modeling of certain backgrounds,
additional shape variations are introduced on most templates
(i.e. all but the \Dstar combinatorial template have some shape variations which
will be discussed later).

\begin{table}[!htb]
    \centering
    \caption{
        Fit variables and their binnings,
        obtained by the rest frame approximation technique as described
        in \cref{appx:rfa}.
    }
    \label{tab:fit-vars-binning}
    \begin{tabular}{c|l}
        \toprule
        {\bf Variable} & {\bf Binning} \\
        \midrule
        \mmSq [\GeVSq] & 43, -2 -- 10.9 \\
        \el [MeV]      & 34, 100 -- 2650 \\
        \qSq [\GeVSq]  & 4, -0.4 -- 12.6 \\
        \bottomrule
    \end{tabular}
\end{table}

% Pointer to later subsections
The remainder of this chapter is organized as following:
a description on template generation,
followed by a discussion on all components of fit templates,
is described in \cref{ref:fit:tmpl}.
The fit template shape variations are explained in
\cref{ref:fit:var}.
The blinded fitted results are provided in
\cref{ref:fit:results}.


\input{section/fit-fit-templates.tex}
\input{section/fit-fit-variations.tex}
\input{section/fit-fit-results.tex}
