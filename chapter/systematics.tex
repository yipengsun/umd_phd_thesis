\chapter{Systematic uncertainties}
\label{ref:sys-uncert}

The major sysmtematics uncertainties are evaluated as listed in
\cref{tab:sys-uncert}.
The corresponding uncertainties from the run 1 analysis evaluated with
the \HistFactory fitter is also provided as reference.
Unless specified, all uncertainties are \emph{absolute} uncertainties.
All uncertainties are \emph{multiplied by 100} for convenience.

\begin{table}[!htb]
    \caption{
        Evaluated systematic uncertainties.
        Run 1 uncertainties are provided as a reference inside parentheses.
        All uncertainties are absolute, not relative.
        The additive uncertainties are sorted in descending order by their run 1
        significance.
        Currently the MC statistical uncertainties are not taken into account.
    }
    \label{tab:sys-uncert}
    \centering
    \footnotesize
    \begin{tabular}{r|c|c|c}
        \toprule
        {\bf Source} & {\bf $\sigma_{\RDst}$ [$\times 10^{-2}$]} &
                       {\bf $\sigma_{\RD}$   [$\times 10^{-2}$]} &
                       {\bf Correlation} \\
        \midrule
        %%%%
        $B \rightarrow D^{(*)}\ellm\neulb$ form factors &
        0.53 (0.58) & 0.79 (2.37) & -0.71 (-0.80) \\
        %%%%
        $B \rightarrow D^{**}\ellm\neulb$ form factors &
        0.25 (0.78) & 0.62 (1.01) & -0.85 (-0.10) \\
        %%%%
        Control sample shape parameters\parnote{
            \label{parnote:ctrl-shape-params}
            This uncertainty is not part of the nominal uncertainties reported
            by the fit.
        } &
        0.46 (0.87) & 0.96 (4.36) & (-0.49) \\
        %%%%
        $DD$ model dependence\parnoteref{parnote:ctrl-shape-params} &
        (0.63) & (0.74) & (0.00) \\
        %%%%
        $B \rightarrow \Dstst\taum\neutb$ bkg &
        0.21 (0.17) & 0.23 (0.30) & (0.78) \\
        %%%%
        $B \rightarrow D^{(*)} \Dstst_s (\rightarrow \taum\neutb) X$ bkg &
        0.37 (0.25) & 0.59 (1.21) & (0.59) \\
        %%%%
        \muon misID unfolding algorithm\parnoteref{parnote:ctrl-shape-params} &
        (0.74) & (1.19) & 1.00 (1.00) \\
        %%%%
        Coulomb correction to $\mathcal{R}(\Dstarp)$ vs. $\mathcal{R}(\Dstarz)$\parnoteref{parnote:ctrl-shape-params} &
        0.27 (0.17) & 0.21 (0.3) & -1.00 (-1.00) \\
        %%%%
        \muon misID decay-in-flight correction &
        0.05 (0.06) & 0.14 (0.16) & (0.29) \\
        %%%%
        Combinatorial background shape\parnoteref{parnote:ctrl-shape-params} &
        (0.03) & (0.18) & (0.00) \\
        %%%%
        Vertex resolution correction\parnoteref{parnote:ctrl-shape-params} &
        (0.03) & (0.21) & (-0.25) \\
        %%%%
        Data/MC corrections (add.)\parnoteref{parnote:ctrl-shape-params} &
        (0.40) & (0.75) & (0.00) \\
        %%%%
        \midrule
        Data/MC corrections (mul.) &
        \makecell{$? \times \RDst$ \\ ($1.16 \times \RDst$)} &
        \makecell{$? \times \RD$ \\ ($0.91 \times \RDst$)} &
        (0.00) \\
        %%%%
        $\mathcal{B}(\taum \rightarrow \mun\neumb\neut)$ (ext. mea.) &
        0.23 (0.23) & 0.23 (0.23) & 1.00 (1.00) \\
        \midrule
        %%%%
        Sys. + stats. &
        ? & ? & ? \\
        \bottomrule
    \end{tabular}
    \parnotes
\end{table}

The remainder of the chapter is dedicated to explain the evaluation method
for each tabulated systematic uncertainty.
These uncertainties can be loosely classified into the following groups:
Form factors (\cref{sys-ff}),
under-constrained $\tau$ components (\cref{sys-tau-dstst,sys-tau-ddx}),
uncertainties on the modeling of the background components
(\cref{sys-model-ctrl,sys-model-ddx,sys-model-dif,sys-model-comb}),
uncertainties on employed algorithms (\cref{sys-algo-misid}),
theoretical corrections not included in the nominal fit
(\cref{sys-theory-coulomb}),
and uncertainties on data/MC corrections
(\cref{sys-cor-vtx,sys-cor-rwt}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{$B \rightarrow (\Dz|\Dstar|\Dstst)\ellm\neulb$ form factors}
\label{sys-ff}

The uncertainties due to $D^{(*,**)}$ form factors affect the shapes of the fit
variables,
as discussed in \cref{ref:mc-cor:ff};
the FFs are listed in
\cref{ref:theory:ff-d0,ref:theory:ff-dst,ref:theory:ff-dstst}.
The uncertainties due to these parameters can be determined in the following
manner:

\begin{enumerate}
    \item Perform a fit with the nominal settings and call
        the fitted value $\RDX = v\;{+\sigma_+}\;{-\sigma_-}$.
    \item Fix the variations ($\alpha$ parameters) associated the form factor
        parameters at the fitted value.
        This removes the constrains due to these $\alpha$ parameters in the
        likelihood thus
        eliminates all uncertainties due to these parameters.
    \item Repeat the fit with the $\alpha$ parameters fixed at the fitted
        value.
        Denote the new fitted value
        $\RDX' = v'\;{+\sigma'_+}\;{-\sigma'_-}$.
    \item The systematic uncertainty due to the form factors are
        obtained from subtracting uncertainties of \RDX and $\RDX'$ in
        quadrature.
        More specifically, due to the asymmetric nature of the error,
        the systematic uncertainty is calculated with
        \cref{eqn:sys-uncert-sub-quad}:

        \begin{equation}
            \sigma_\text{sys} = \sqrt{\sigma_+ \sigma_- - \sigma'_+ \sigma'_-}
            \label{eqn:sys-uncert-sub-quad}
        \end{equation}
\end{enumerate}

% Use the compute_systematics.py to compute systematics from the fit log files
% directly! e.g.:
%   compute_systematics.py 23_02_12_08_41-fit_step3-2016_all-reweighted/step3.log -s 23_02_12_18_33-fit_sys-ff-D0_Dst/step3.log

The systematic uncertainty due to \Dz and \Dstar form factors is 0.79 for
\RD and 0.53 for \RDst;
uncertainties on \Dstst form factors leads to an uncertainty of 0.62 for \RD and
0.25 for \RDst.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{$B \rightarrow D^{**}\taum\neutb$ background}
\label{sys-tau-dstst}

As discussed in \cref{tmpl:dstst},
the $B \rightarrow \Dstst \taum\neutb$ tauonic yields are not well-constrained
by external measurements,
with their yields allowed to fluctuate with a Gaussian constraint of
$\sigma = 0.33$
(so that an increase from the nominal yield $N$ to $1.33N$ would result in a
1-$\sigma$ penalty in the corresponding log-likelihood function).
The systematic uncertainty introduced by the Gaussian constrains
is evaluated based on the differences between the fit uncertainties resulting
from floating and fixing these parameters at their best fit values,
as described in \cref{sys-ff}.
The uncertainty due to tauonic \Dstst backgrounds is 0.23 for \RD,
and 0.21 for \RDst.

% tau D**:
%   R(D) : +5.884805/--6.077341
%   R(D*): +1.961466/--1.895818


\section{$B \rightarrow D^{(*)} D^{**}_s (\rightarrow \tau\neutb) X$ background}
\label{sys-tau-ddx}

Similar to \cref{sys-tau-dstst},
the $B \rightarrow D^{(*)} D^{**}_s (\rightarrow \tau\neutb) X$ tauonic yields
are only loosely constrained with a Gaussian whose $\sigma = 0.3$,
as discussed in \cref{ref:fit:tmpl:ddx}.
Using the same method of taking the quadrature difference of floating and fixing
these parameters at their fitted values,
the uncertainty due to tauonic $DDX$ backgrounds is 0.59 for \RD,
and 0.37 for \RDst.

% tau DDX:
%   R(D) : +5.844685/--6.069123
%   R(D*): +1.933537/--1.874157


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Control sample shape parameters}
\label{sys-model-ctrl}

As discussed in \cref{ref:fit},
in the signal (ISO) fit,
the shape parameters for the background templates,
namely \Dstst, $\Dstst_H$, and $DDX$,
are loaded from the fitted values of the control fit,
with the $\Dstst_H$ and $DDX$ parameters held fixed and the \Dstst
shape parameters,
which are form factors,
constrained.
These parameters are referred as the
\emph{control sample shapes parameters}.

To propagate the uncertainties from the control sample shape parameters to
the signal fit,
a bootstrap procedure is performed which generates alternative parameters based
on the correlations among these parameters.
Since the systematic uncertainties from the \Dstst form factors are
studied separately,
to avoid double counting,
a \emph{conditional covariance matrix},
which removes the covariance \emph{purely due to} \Dstst FFs,
is used in the bootstrap procedure.
As an example,
for the \Dstst form factors,
the bootstrap permits variations due to
correlations between them and the $DDX$/$\Dstst_H$ shape parameters \emph{only}.
%%%%
The removal is carried out with the following procedure:

\begin{enumerate}
    \item Start from the full 16-dimensional space of shape variations
        parameters, all obtained from a fit in the control sample:
        8 $DDX$ shape parameters,
        3 $D^{**}_H$ parameters,
        and 5 $D^{**}$ form factor parameters.
        Denote the covariance matrix as $M$.

    \item Block decompose $M$ into:
        \begin{equation}
            M =
            \begin{bmatrix}
                \Sigma_{11} &  \Sigma_{12} \\
                \Sigma_{21} &  \Sigma_{22} \\
            \end{bmatrix}
        \end{equation}
        such that $\Sigma_{11}$,
        5 dimensional,
        corresponds to the raw correlations between
        $D^{**}$ form factors variations and
        $\Sigma_{22}$, 11 dimensional,
        $DDX$ and $D^{**}_H$ shape parameters.

    \item The covariance purely among the \Dstst FFs,
        or formally the \emph{conditional covariance} of $D^{**}$ form factor
        variations conditioned on the fitted values and uncertainties of
        the $DDX$ and $D^{**}_H$ shape parameters,
        denoted as $C$, is obtained with:

        % formula taken from:
        %   https://stats.stackexchange.com/questions/30588/deriving-the-conditional-distributions-of-a-multivariate-normal-distribution
        % also, the formula has the correction matrix dimensionality.
        % for example, let dim(S11) = 5x5 and dim(S22) = 2x2
        % then dim(S12) = 5x2 and
        % dim(S12 x S22^-1 x S21) = 5x2 x 2x2 x 2x5 = 5x5
        \begin{equation}
            C = \Sigma_{11} - \Sigma_{12} \Sigma^{-1}_{22} \Sigma_{21}
        \end{equation}

    \item The reduced covariance matrix $R$ is obtained by subtracting $C$ from
        $\Sigma_{11}$.
\end{enumerate}

With the reduced covariance matrix $R$, toys of shape parameters satisfying
the covariance can be generated by Cholesky decomposition and random vectors
sampled from independent Gaussian distributions.
Each set of the parameters is loaded in the signal fit as the best
fitted control parameters and the fit is repeated normally,
with the fitted value of \RDX recorded.
The root-mean-square of the distribution of \RDX fitted this way is taken as
the systematic uncertainty,
which is 0.96 for \RD, and 0.46 for \RDst.

%      |      0    |      1    |
% -------------------------------
%    0 |  2.147e-05  -4.198e-05
%    1 | -4.198e-05    9.23e-05


\section{$DD$ model dependence}
\label{sys-model-ddx}

In the nominal fit, two variations on $m_{DD^{*}}$,
a key proxy variable to the 3-body decay phase space,
are introduced on $DDX$ templates to allow for a data-driven approach to
determine the shape of these templates, as described in
\cref{ref:fit:var:ddx}.

To estimate the dependence on the choice of proxy variable to the phase space,
alternative proxy variables, namely $m_{DK}$ and $p_D$ in the \B rest frame,
are deformed linearly and quadratically,
the nominal $DDX$ templates are replaced with these alternative variations,
and a refit is performed.
The quadratic differences between the fitted uncertainties with the nominal and
alternative $DD$ model are taken as the systematic uncertainty.

The variations of $m_{DK}$ take the same form of
\cref{eqn:dal-var-lin,eqn:dal-var-quad}, with $m_{DD^{(*)}}$ replaced by
$m_{DK}$.
The mass limits are also replaced:
$m_\text{min} = m_{D^{(*)}} + m_K$, $m_\text{max} = m_B - m_D^{(*)}$.


\section{\muon misID decay-in-flight correction}
\label{sys-model-dif}

As discussed in \cref{ref:fit:var:misid-dif},
the DiF effect is included as a shape variation to allow the fit to determine
the strength of the DiF effect.
The uncertainty due to this variation is evaluated with results
from floating vs. fixing at the fitted value for the associated $\alpha$
parameter,
which is 0.14 for \RD and 0.05 for \RDst.

% misID DiF:
%   R(D) : +5.895820/--6.071454
%   R(D*): +1.968943/--1.912630


\section{Combinatorial background shapes}
\label{sys-model-comb}

The nominal \BComb templates include a linear correction that depends on $m_B$,
which is needed because this background is derived from the wrong-sign control
sample and the raw yields between the wrong-sign and the right-sign samples
in the $B$ mass upper side band do not match,
as discussed in \cref{ref:fit:tmpl:comb}.

However, as also discussed in the same section,
the \BComb is empirically modeled as an exponential of the form
$A e^{-\lambda m_b}$,
where $A, \lambda$ are fitted from data.
We assume both the wrong-sign and right-sign combinatorial backgrounds have the
same functional form,
therefore, the correction factor is the ratio between two exponential functions,
which itself is an exponential,
with the leading mass-dependent order correction linear.

The uncertainty on the linear correction factor is quantified by
repeating the fit with the nominal \BComb templates substituted with
the ones generated with the exponential correction,
as shown in
\cref{fig:b-comb-d0,fig:b-comb-dst}.
The quadrature difference between \RDX is taken as the associated systematic
uncertainty.
The exponential correction is \emph{not taken as the nominal} because the
existing data cannot resolve $A, \lambda$ to high precision.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\muon misID unfolding algorithm}
\label{sys-algo-misid}

Two main sources of uncertainties are identified to affect the \muon misID
unfolding algorithm, an algorithm to estimate the contributions from charged
particles mis-identified as \muon (\cref{ref:fit:tmpl:misid}):
\begin{itemize}
    \item The limited statistics of the misID data control sample
    \item The accuracy of the efficiency for a ghost track to pass the \muon
        selection requirements $\epsilon(g_\text{acc} \rightarrow \hat{mu})$,
        (ghost mis-identification efficiency)
        since this is modeled from a MC sample.
\end{itemize}

To evaluate the uncertainties due the limited statistical power,
the misID algorithm is intentionally configured to \emph{over-fit} the control
sample;
a fit is then repeated with the over-fit misID templates and the quadratic
difference of the fit uncertainties are taken as the systematic uncertainty.
Similarly, for the ghost mis-identification efficiency,
ghost tracks in an alternate MC sample with the wrong underlying decay
($B_c \rightarrow \jpsi\mun\neumb$ instead of $B \rightarrow D \mum\neumb$) are
used instead to produce alternative misID templates.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coulomb correction to $\mathcal{R}(\Dstarp)$ vs. $\mathcal{R}(\Dstarz)$}
\label{sys-theory-coulomb}

The MC simulation lacks the corrections from Coulomb interactions between
the lepton and the charged hadrons in
$\Bzb \rightarrow \Dstarp\ellm\neulb$ decays.
This correction leads to three effects:

\begin{enumerate}
    \item A deformation of the
        $B \rightarrow \Dstarp\ellm\neulb$ fit templates,
        particularly for the tauonic
        $\Bzb \rightarrow \Dstarp\taum\neutb$ decay.
    \item A shift in the efficiency ratio between $\Dstarp\tau$ and $\Dstarp\mu$
        decays.
    \item Breaking of the isospin symmetry between
        $\mathcal{R}(\Dstarp)$ and $\mathcal{R}(\Dstarz)$
\end{enumerate}

The first two effects are checked in \cite{LHCb-ANA-2020-056} to be negligible
compared to existing additive and multiplicative uncertainties.
The third effect results in about 1\% relative enhancement in $\mathcal{R}
(\Dstarp)$ compared to $\mathcal{R}(\Dstarz)$,
as reported in \cite{Cal__2019},
which is implemented by setting
$\tilde{\eta}_{\Dstarp}^\text{new} = \frac{\tilde{\eta}_{\Dstarp}}{1.01}$
then repeat the fit,
leading to an uncertainty of 0.21 for \RD,
and 0.27 for \RDst.

% Coulomb correction:
%   R(D) : +5.990866/--5.986161
%   R(D*): +1.959131/--1.959104


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Vertex resolution correction}
\label{sys-cor-vtx}

As discussed in \cref{ref:mc-cor:vertex},
the mis-modeling of the $B$ flight vector in the MC simulation is corrected by
smearing on the azimuthal angle of the flight vector.
To assess the uncertainty due to this smearing,
an additional variation to either enhance or reduce the smearing effect
by assigning a larger/smaller weight to events with larger smearing angles,
which in turn widens or narrows the $B$ vertex and the \mmSq resolution,
% as shown in \cref{fig:vtx-res},
is introduced \emph{for every single MC template}.

Since such a smearing changes the shape of fit variables for all MC templates,
the variation introduces a non-trivial correlation to every
shape variation parameter.
To evaluate the uncertainty \emph{purely due to the variation on smearing},
all other shape variations are fixed at the best fit values before a refit is
performed.
The results are subtracted in quadrature as usual to obtain the systematic
uncertainty due to the smearing.


\section{Data/MC corrections}
\label{sys-cor-rwt}

Had the data/MC corrections been perfect,
after an iteration of the fit is performed,
the low \mmSq region between the data and the post-fit cocktail
(defined in \cref{ref:mc-cor:postfit-cocktail}) should be statistically
consistent,
because this normalization enriched region is insensitive to other effects
due to modeling of physics backgrounds.
In reality the data/MC corrections are not perfect,
and the uncertainty due to this is assessed by doing an additional iteration of
the final reweighting (explained in \cref{ref:mc-cor:final}),
regenerating the fit templates,
and then repeating the fit.

The effect of such a correction is broken into an additive and a multiplicative
component, which the latter affect the efficiency ratios
(the 4 $\eta$ parameters discussed in \cref{tmpl:norm,tmpl:sig}).

% Beston-Barlow
%  for a given bin i -> \sigma_{\text{rel},i}
%  sigma_{rel,i} = \sum_\text{input histogram $j$} \sigma_{i,j} / N_{i,j}
%  \sigma_{i,j} -> getBinError()
