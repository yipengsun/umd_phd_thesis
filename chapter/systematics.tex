\chapter{Systematic uncertainties}
\label{ref:sys-uncert}

The major sysmtematics uncertainties are evaluated as listed in
\cref{tab:sys-uncert}.
The corresponding uncertainties from the run 1 analysis evaluated with
the \HistFactory fitter is also provided as reference.
Unless specified, all uncertainties are \emph{absolute} uncertainties.

\begin{table}[!htb]
    \caption{
        Evaluated systematic uncertainties.
        Run 1 uncertainties are provided as a reference inside parentheses.
        All uncertainties are absolute, not relative.
        The additive uncertainties are sorted in descending order by their run 1
        significance.
        Currently the MC statistical uncertainties are not taken into account.
    }
    \label{tab:sys-uncert}
    \centering
    \small
    \begin{tabular}{r | c | c }
        \toprule
        {\bf Source} & {\bf $\RDst, \times 10^2$} &
                       {\bf $\RD  , \times 10^2$} \\
        \midrule
        %%%%
        $B \rightarrow D^{(*)}\ell\neulb$ form factors &
        (0.58) & (2.37) \\
        %%%%
        $B \rightarrow D^{**}\ell\neulb$ form factors &
        (0.78) & (1.01) \\
        %%%%
        Control sample shape params &
        (0.87) & (4.36) \\
        %%%%
        $DD$ model dependence &
        (0.63) & (0.74) \\
        %%%%
        $B \rightarrow D^{**}\tau\neutb$ bkg &
        (0.17) & (0.30) \\
        %%%%
        $B \rightarrow D^{(*)} D^{**}_s (\rightarrow \tau\neutb) X$ bkg &
        (0.25) & (1.21) \\
        %%%%
        \muon misID unfolding algorithm &
        (0.74) & (1.19) \\
        %%%%
        Coulomb correction to $\mathcal{R}(\Dstarp)$ vs. $\mathcal{R}(\Dstarz)$ &
        (0.17) & (0.3) \\
        %%%%
        \muon misID decay-in-flight correction &
        (0.06) & (0.16) \\
        %%%%
        Comb. bkg. shape &
        (0.03) & (0.18) \\
        %%%%
        Vertex resolution correction &
        (0.03) & (0.21) \\
        %%%%
        Data/MC corrections (add.) &
        (0.40) & (0.75) \\
        %%%%
        \midrule
        Data/MC corrections (mul.) &
        \makecell{$? \times \RDst$ \\ ($1.16 \times \RDst$)} &
        \makecell{$? \times \RDst$ \\ ($0.91 \times \RDst$)} \\ % FIXME: Really? Both R(D*)?
        %%%%
        $\mathcal{B}(\taum \rightarrow \mun\neumb\neut)$ &
        0.23 & 0.23 \\
        \midrule
        %%%%
        Sys. + stats. &
        ? & ? \\
        \bottomrule
    \end{tabular}
\end{table}

The remainder of the chapter is dedicated to explain the evaluation method
for each tabulated systematic uncertainty.
These uncertainties can be loosely classified into the following groups:
Form factors (\cref{sys-ff}),
under-constrained $\tau$ components (\cref{sys-tau-dstst,sys-tau-ddx}),
uncertainties on the modeling of the background components
(\cref{sys-model-ctrl,sys-model-ddx,sys-model-dif,sys-model-comb}),
uncertainties on employed algorithms (\cref{sys-algo-misid}),
theoretical corrections not included in the nominal fit
(\cref{sys-theory-coulomb}),
and uncertainties on data/MC corrections
(\cref{sys-cor-vtx,sys-cor-rwt}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{$B \rightarrow (\Dz|\Dstar|\Dstst)\ell\neulb$ form factors}
\label{sys-ff}

The uncertainties due to $D^{(*)}$ form factors can be determined in the
following manner:

\begin{enumerate}
    \item Perform a fit with nominal setting. Say the fitted value for
        $\RD = V\;{+\sigma_+}\;{-\sigma_-}$.
    \item Fix the variations ($\alpha$ parameters) associated with \Dz and
        \Dstar form factor parameters at best fitted value.
        This removes the constrains due to these $\alpha$ parameters in the
        likelihood thus
        eliminates all uncertainties due to these parameters.
    \item Repeat the fit with the $\alpha$ parameters fixed at the best fitted
        value.
        Say now the fitted value for
        $\RD = V'\;{+\sigma'_+}\;{-\sigma'_-}$.
    \item The systematic uncertainty due to \Dz and \Dstar form factors are
        obtained from subtracting uncertainties of $V, V'$ in quadrature.
        More specifically, due to the asymmetric nature of the error,
        the systematic uncertainty is calculated with
        \cref{eqn:sys-uncert-sub-quad}:

        \begin{equation}
            \sigma_\text{sys} = \sqrt{\sigma_+ \sigma_- - \sigma'_+ \sigma'_-}
            \label{eqn:sys-uncert-sub-quad}
        \end{equation}
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{$B \rightarrow D^{**}\tau\neutb$ background}
\label{sys-tau-dstst}

As discussed in \cref{tmpl:dstst},
the tauonic yields are not well-constrained by external measurements, and
are floated with a Gaussian constraint for each fit channel.
The systematic uncertainty introduced by the Gaussian constrains
is evaluated based on differences between floating and fixing these parameters
at best fit values, as described in \cref{sys-ff-d0-dst}.


\section{$B \rightarrow D^{(*)} D^{**}_s (\rightarrow \tau\neutb) X$ background}
\label{sys-tau-ddx}

The situation is similar to \cref{sys-tau-dstst}.
The uncertainty on the \tauon vs. \muon relative fractions,
discussed in \cref{ref:fit:tmpl:ddx},
is evaluated with results from floating vs. fixing at best values.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Control sample shape parameters}
\label{sys-model-ctrl}

As discussed in \cref{ref:fit:procedure},
in the signal (ISO) fit,
the shapes of $DDX$ and $D^{**}_H$ templates
are fixed to the fitted values obtained from the control fit.
In addition, the $D^{**}$ form factor shape variations are \emph{constrained}
rather than fixed from the control fit.
These parameters are collectively referred as
\emph{control sample shapes parameters},

To propagate the uncertainties from the control sample shape parameters to
the signal fit,
a bootstrap procedure is performed which generates alternative parameters based
on the correlations among these parameters.
Due to the fact that the systematic uncertainties from $D^{**}$ form factor
variations are studied separately,
to avoid double counting,
the correlations \emph{purely} among these form factor variations need to be
removed\footnote{
    Admittedly the correlations between form factor variations and the rest of
    the control shape parameters are weak.
}.
For example, for $D^{**}$ form factors variations,
this study permits variations due to
correlations between them and the $DDX$/$D^{**}_H$ shape parameters \emph{only}.
%%%%
The removal is carried out with the following procedure:

\begin{enumerate}
    \item Start from the full 16-dimensional space of shape variations
        parameters, all obtained from a fit in the control sample:
        8 $DDX$ shape parameters,
        3 $D^{**}_H$ parameters,
        and 5 $D^{**}$ form factor parameters.
        Denote the covariance matrix as $M$.

    \item Block decompose $M$ into:
        \begin{equation}
            M =
            \begin{bmatrix}
                \Sigma_{11} &  \Sigma_{12} \\
                \Sigma_{21} &  \Sigma_{22} \\
            \end{bmatrix}
        \end{equation}
        such that $\Sigma_{11}$,
        5 dimensional,
        corresponds to the raw correlations between
        $D^{**}$ form factors variations and
        $\Sigma_{22}$, 11 dimensional,
        $DDX$ and $D^{**}_H$ shape parameters.

    \item The covariance purely among $D^{**}$ form factor variations,
        or formally the \emph{conditional covariance} of $D^{**}$ form factor
        variations conditioned on best fitted values of $DDX$ and $D^{**}_H$
        shape variations, denoted as $C$, is obtained with:

        \begin{equation}
            C = \Sigma_{11} - \Sigma_{12} \Sigma^{-1}_{22} \Sigma_{21}
        \end{equation}

    \item The reduced covariance matrix $R$ is obtained by
        subtracting elements in $C$ from elements in $M$ corresponding to the
        same parameters.
\end{enumerate}

With the reduced covariance matrix $R$, toys of shape parameters satisfying
the covariance can be generated by Cholesky decomposition and random vectors
sampled from independent Gaussian distributions.
Each set of the parameters is loaded in the signal fit as the best
fitted control parameters and the fit is repeated normally,
with the fitted value of \RDX recorded.
The uncertainty on the distribution of \RDX fitted this way is taken as the
systematic uncertainty.


\section{$DD$ model dependence}
\label{sys-model-ddx}

In the nominal fit, two variations on $m_{DD^{*}}$,
a key proxy variable to 3-body decay phase space,
are introduced on $DDX$ templates to allow for a data-driven approach to
determine the shape of these templates, as described in
\cref{ref:fit:var:ddx}.

To estimate the dependence on the choice of proxy variable to the phase space,
alternative proxy variables, namely $m_{DK}$ and $p_D$ in the \B rest frame,
are deformed linearly and quadratically and the nominal $DDX$ templates are
replaced with these alternative variations and a refit performed.
A profile likelihood study then determine the uncertainty of \RD and \RDst
based on a likelihood profile study\footnote{
    For more details, see APPX % TODO: List details for profile likelihood study
} of both the nominal and the alternative variations.

The variations of $m_{DK}$ take the same form as
\cref{eqn:dal-var-lin,eqn:dal-var-quad}, with $m_{DD^{(*)}}$ replaced by
$m_{DK}$.
The mass limits are also replaced:
$m_\text{min} = m_{D^{(*)}} + m_K$, $m_\text{max} = m_B - m_D^{(*)}$.
Similarly, for variations of $p_D$, the min and max are computed based on the
phase space limit of a 3 body decay.


\section{\muon misID decay-in-flight correction}
\label{sys-model-dif}

As discussed in \cref{ref:fit:var:misid-dif},
the DiF effect is included as a shape variation to allow the fit to determine
the strength of the DiF effect.
The uncertainty due to this variation is evaluated with results
from floating vs. fixing at best value for the associated $\alpha$ parameter.


\section{Combinatoric background shapes}
\label{sys-model-comb}

The nominal \BComb templates include a linear correction depend on $m_B$,
which is discussed in \cref{ref:fit:tmpl:comb}.
However, the actual correction is of a form $e^{-\lambda m_B}$
(where $\lambda$ is fitted from data;
the exponential fits are displayed side-by-side with the linear fits in
\cref{fig:b-comb-d0,fig:b-comb-dst}.)
and the linear correction is only the leading order approximation of the
exponential.

The uncertainty on the linear correction factor is quantified by
repeating the fit with the nominal \BComb templates substituted with
the ones generated with the exponential correction.
The quadrature difference between \RDX is taken as the associated systematic
uncertainty.
The exponential correction is \emph{not taken as the nominal} because the
existing data cannot resolve $\lambda$ to high precision.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\muon misID unfolding algorithm}
\label{sys-algo-misid}

This is a work in progress.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coulomb correction to $\mathcal{R}(\Dstarp)$ vs. $\mathcal{R}(\Dstarz)$}
\label{sys-theory-coulomb}

The MC simulation lacks the corrections from Coulomb interactions between
the lepton and the charged hadrons in
$\Bzb \rightarrow \Dstarp\ell\neulb$ decays.
This correction leads to three effects:

\begin{enumerate}
    \item A deformation of the templates, particularly
        $\Bzb \rightarrow \Dstarp\tauon\neutb$ decays.
    \item A shift in the efficiency ratio between $\Dstarp\tau$ and $\Dstarp\mu$
        decays.
    \item Breaking of isospin symmetry between
        $\mathcal{R}(\Dstarp)$ and $\mathcal{R}(\Dstarz)$
\end{enumerate}

The first two effects are checked in \cite{LHCb-ANA-2020-056} to be negligible
compared to existing additive and multiplicative uncertainties.
The third effect results in about 1\% relative enhancement in $\mathcal{R}
(\Dstarp)$ compared to $\mathcal{R}(\Dstarz)$,
as reported in \cite{Cal__2019}.
A refit is performed to evaluate the uncertainty to due this change.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Vertex resolution correction}
\label{sys-cor-vtx}

As mentioned in \cref{ref:mc-cor:vertex},
the mis-modeling of the $B$ flight vector in MC is corrected by a smearing
on the azimuthal angle of the flight vector.
To access the uncertainty due to this smearing, an additional
variation to either strengthen or suppress the smearing effect is introduced
\emph{for every single MC template}.

Due to the fact that the smearing changes the shape of fit variables for all
MC templates, the variation introduces a non-trivial correlation to every
shape variation parameter.
To evaluate the uncertainty \emph{purely due to the variation on smearing},
all other shape variations are fixed at the best fit values before a refit is
performed.
The results are subtracted in quadrature as usual to obtain the systematic
uncertainty due to the smearing.


\section{Data/MC corrections}
\label{sys-cor-rwt}

Had the data/MC corrections been perfect,
after an iteration of the fit is performed,
the low \mmSq region between data and post-fit cocktail
(defined in \cref{ref:mc-cor:postfit-cocktail}) should be in perfect agreement
(statistically speaking)
because this normalization enriched region is insensitive to other effects
due to modeling of physics backgrounds.
In reality the data/MC corrections are not perfect,
and the uncertainty due to this is assessed by repeating
the final reweighting (explained in \cref{ref:mc-cor:final}),
regenerating the fit templates,
then repeating the fit.
